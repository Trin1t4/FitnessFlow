import passport from "passport";
import session from "express-session";
import type { Express } from "express";
import { Issuer, Strategy, type UserinfoResponse } from "openid-client";
import connectPgSimple from "connect-pg-simple";
import pg from "pg";

const PgSession = connectPgSimple(session);

interface ReplitUserinfo extends UserinfoResponse {
  sub: string;
  name: string;
  profile?: string;
  picture?: string;
  email: string;
  email_verified: boolean;
  aud: string;
  exp: number;
  iat: number;
  iss: string;
}

export async function setupAuth(app: Express) {
  // âœ… Verifica SESSION_SECRET obbligatorio
  if (!process.env.SESSION_SECRET) {
    throw new Error("âŒ SESSION_SECRET Ã¨ obbligatorio! Aggiungilo in Replit Secrets.");
  }

  const pool = new pg.Pool({
    connectionString: process.env.DATABASE_URL,
  });

  const issuerUrl = process.env.ISSUER_URL || "https://replit.com/oidc";

  const replitIssuer = await Issuer.discover(issuerUrl);

  const client = new replitIssuer.Client({
    client_id: process.env.REPLIT_DEPLOYMENT
      ? `${process.env.REPL_ID}-${process.env.REPL_OWNER}`
      : process.env.REPL_ID ?? "unknown",
    token_endpoint_auth_method: "none",
  });

  // âœ… Determina correttamente il redirect_uri per tutti gli ambienti
  let redirectUri: string;
  
  if (process.env.REPLIT_DEPLOYMENT) {
    // Production deployment su Replit (*.replit.app)
    redirectUri = `https://trainsmart.replit.app/api/callback`;
  } else if (process.env.REPL_SLUG && process.env.REPL_OWNER) {
    // Development su Replit (*.repl.co)
    redirectUri = `https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co/api/callback`;
  } else {
    // Development locale
    redirectUri = `http://localhost:5000/api/callback`;
  }

  console.log("ðŸ” OAuth redirect_uri:", redirectUri);

  const strategy = new Strategy(
    {
      client,
      params: {
        redirect_uri: redirectUri,
      },
    },
    (tokenSet: any, userinfo: ReplitUserinfo, done: any) => {
      return done(null, { tokenSet, userinfo });
    }
  );

  passport.use("oidc", strategy);

  passport.serializeUser((user: any, done) => {
    done(null, user);
  });

  passport.deserializeUser((user: any, done) => {
    done(null, user);
  });

  // âœ… Configurazione ambiente-aware per Replit
  const isProduction = process.env.NODE_ENV === "production";
  const isReplit = !!process.env.REPL_SLUG;
  const isHttps = isProduction || isReplit;

  console.log("ðŸª Cookie config:", { isProduction, isReplit, isHttps });

  app.use(
    session({
      store: new PgSession({
        pool,
        tableName: "user_sessions",
        createTableIfMissing: true,
      }),
      secret: process.env.SESSION_SECRET,
      resave: false,
      saveUninitialized: false,
      cookie: {
        maxAge: 30 * 24 * 60 * 60 * 1000, // 30 giorni
        httpOnly: true,
        secure: isHttps, // âœ… true su Replit (HTTPS) anche se development
        sameSite: isHttps ? "none" : "lax", // âœ… "none" necessario per OAuth cross-domain
      },
    })
  );

  app.use(passport.initialize());
  app.use(passport.session());

  app.get("/api/login", (req, res, next) => {
    passport.authenticate("oidc")(req, res, next);
  });

  app.get("/api/callback", (req, res, next) => {
    passport.authenticate("oidc", {
      successRedirect: "/",
      failureRedirect: "/?error=auth_failed",
    })(req, res, next);
  });

  app.get("/api/logout", (req, res) => {
    req.logout(() => {
      res.redirect("/");
    });
  });

  app.get("/api/auth/user", (req, res) => {
    if (req.isAuthenticated()) {
      res.json(req.user);
    } else {
      res.status(401).json({ message: "Unauthorized" });
    }
  });
}

export function isAuthenticated(req: any, res: any, next: any) {
  if (req.isAuthenticated()) {
    return next();
  }
  res.status(401).json({ message: "Unauthorized" });
}