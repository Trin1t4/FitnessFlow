üéØ PROBLEMA PRINCIPALE TROVATO
Nel tuo routes.ts vedo che manca il setup della sessione! Hai setupAuth(app) alla riga 212, ma prima devi configurare express-session.
üõ†Ô∏è SOLUZIONE: Correggi server/index.ts
Il tuo server/index.ts deve avere questo ordine ESATTO:
typescriptimport express from "express";
import session from "express-session";
import pgSession from "connect-pg-simple";
import { pool } from "./db"; // Assicurati di avere questo export

const app = express();

// 1Ô∏è‚É£ MIDDLEWARE BASE (PRIMA DI TUTTO)
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

// 2Ô∏è‚É£ SESSION (PRIMA DI AUTH!)
const PgSession = pgSession(session);
app.use(session({
  store: new PgSession({ 
    pool, 
    createTableIfMissing: true 
  }),
  secret: process.env.SESSION_SECRET || 'dev-secret-change-in-prod',
  resave: false,
  saveUninitialized: false,
  cookie: { 
    maxAge: 30 * 24 * 60 * 60 * 1000, // 30 giorni
    secure: false // metti true in production con HTTPS
  }
}));

// 3Ô∏è‚É£ ROUTES (Include gi√† setupAuth dentro)
const server = await registerRoutes(app);

// 4Ô∏è‚É£ ERROR HANDLER
app.use((err: any, req: any, res: any, next: any) => {
  console.error("Server error:", err);
  res.status(500).json({ error: "Internal server error" });
});

// 5Ô∏è‚É£ VITE/STATIC (ULTIMO!)
if (app.get("env") === "development") {
  await setupVite(app, server);
} else {
  serveStatic(app);
}
üîß Controlli Aggiuntivi nel tuo routes.ts
Il tuo file routes √® buono, ma verifica questi dettagli:
1. Verifica export di pool in db.ts
typescript// server/db.ts
import { Pool } from 'pg';

export const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
2. Variabile d'ambiente necessaria
Aggiungi in .env:
bashSESSION_SECRET=your-super-secret-key-change-this-in-production
3. Fix potenziale in replitAuth.ts
Assicurati che setupAuth configuri correttamente gli endpoint:
typescript// server/replitAuth.ts
export async function setupAuth(app: Express) {
  // Verifica che questi endpoint siano definiti:
  app.get('/api/auth/login', ...);
  app.get('/api/auth/callback', ...);
  app.get('/api/auth/logout', ...);
}
‚úÖ Checklist Completa
Prima di testare, verifica:

 server/index.ts ha session PRIMA di registerRoutes
 server/db.ts esporta pool
 .env contiene SESSION_SECRET
 replitAuth.ts ha tutti gli endpoint auth
 Ordine corretto: json ‚Üí urlencoded ‚Üí session ‚Üí routes ‚Üí error handler ‚Üí vite

üöÄ Testa cos√¨:
bash# Restart server
npm run dev

# Poi vai su:
http://localhost:5000/api/auth/user
Se vedi errore 401 "Non autorizzato" ‚Üí PERFETTO! Significa che le route funzionano.
Poi testa il login cliccando sul pulsante login nel frontend.