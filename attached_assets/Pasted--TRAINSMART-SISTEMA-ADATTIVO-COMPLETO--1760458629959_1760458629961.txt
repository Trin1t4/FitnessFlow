// =====================================================
// TRAINSMART - SISTEMA ADATTIVO COMPLETO
// Gestione intelligente: Palestra / Casa / Misto
// Calibrazione automatica effort in base a attrezzatura
// =====================================================

// ===== TIPI BASE =====

export type Goal = 'strength' | 'hypertrophy' | 'weight_loss' | 'performance' | 'rehab';
export type Location = 'gym' | 'home';
export type EquipmentType = 'barbell' | 'dumbbell' | 'kettlebell' | 'band' | 'pullup_bar' | 'bench' | 'none';

export interface UserEquipment {
  barbell: boolean;
  dumbbellMaxKg: number;
  kettlebellKg: number[];
  bands: boolean;
  pullupBar: boolean;
  bench: boolean;
}

export interface Exercise {
  id: string;
  name: string;
  sets: number;
  reps: string | number;
  rest: number; // secondi
  weight?: number;
  tempo?: string; // es: "3-1-1-0"
  notes?: string;
  category: 'compound' | 'isolation' | 'giant_set';
}

export interface GiantSet extends Omit<Exercise, 'category'> {
  category: 'giant_set';
  rounds: number;
  restBetweenRounds: number;
  exercises: {
    name: string;
    reps: string;
    rest: number;
    tempo?: string;
    notes: string;
  }[];
  warningNote: string;
}

export interface ExerciseVariant {
  gym: {
    name: string;
    equipment: EquipmentType[];
    weightMultiplier: number; // moltiplicatore del massimale
  };
  homeWithEquipment: {
    name: string;
    equipment: EquipmentType[];
    weightMultiplier: number;
    minWeightKg?: number; // peso minimo necessario
  };
  homeBodyweight: {
    name: string;
    isGiantSet?: boolean;
  };
}

// ===== DATABASE ESERCIZI =====

export const EXERCISE_DATABASE: Record<string, ExerciseVariant> = {
  
  // GAMBE - SQUAT
  squat: {
    gym: {
      name: "Squat Bilanciere",
      equipment: ['barbell'],
      weightMultiplier: 0.7
    },
    homeWithEquipment: {
      name: "Goblet Squat",
      equipment: ['dumbbell', 'kettlebell'],
      weightMultiplier: 0.4,
      minWeightKg: 12
    },
    homeBodyweight: {
      name: "Squat a Corpo Libero",
      isGiantSet: false
    }
  },

  frontSquat: {
    gym: {
      name: "Front Squat",
      equipment: ['barbell'],
      weightMultiplier: 0.6
    },
    homeWithEquipment: {
      name: "Goblet Squat",
      equipment: ['dumbbell', 'kettlebell'],
      weightMultiplier: 0.4,
      minWeightKg: 12
    },
    homeBodyweight: {
      name: "Squat Jump + Pause Squat",
      isGiantSet: false
    }
  },

  // GAMBE - STACCO
  deadlift: {
    gym: {
      name: "Stacco da Terra",
      equipment: ['barbell'],
      weightMultiplier: 0.7
    },
    homeWithEquipment: {
      name: "Stacco Rumeno Manubri",
      equipment: ['dumbbell'],
      weightMultiplier: 0.5,
      minWeightKg: 20
    },
    homeBodyweight: {
      name: "GIANT_SET_DEADLIFT", // Speciale: restituisce giant set
      isGiantSet: true
    }
  },

  romanianDeadlift: {
    gym: {
      name: "Stacco Rumeno Bilanciere",
      equipment: ['barbell'],
      weightMultiplier: 0.6
    },
    homeWithEquipment: {
      name: "Stacco Rumeno Manubri",
      equipment: ['dumbbell'],
      weightMultiplier: 0.5,
      minWeightKg: 15
    },
    homeBodyweight: {
      name: "Single Leg RDL",
      isGiantSet: false
    }
  },

  // GAMBE - MACCHINE/ACCESSORI
  legPress: {
    gym: {
      name: "Leg Press",
      equipment: ['barbell'], // placeholder per "macchina"
      weightMultiplier: 1.8
    },
    homeWithEquipment: {
      name: "Bulgarian Split Squat",
      equipment: ['dumbbell'],
      weightMultiplier: 0.3,
      minWeightKg: 10
    },
    homeBodyweight: {
      name: "Bulgarian Split Squat",
      isGiantSet: false
    }
  },

  legCurl: {
    gym: {
      name: "Leg Curl",
      equipment: ['barbell'], // macchina
      weightMultiplier: 0.3
    },
    homeWithEquipment: {
      name: "Nordic Curl",
      equipment: ['none'],
      weightMultiplier: 0
    },
    homeBodyweight: {
      name: "Nordic Curl",
      isGiantSet: false
    }
  },

  // PETTO
  benchPress: {
    gym: {
      name: "Panca Piana Bilanciere",
      equipment: ['barbell', 'bench'],
      weightMultiplier: 0.7
    },
    homeWithEquipment: {
      name: "Panca Manubri",
      equipment: ['dumbbell', 'bench'],
      weightMultiplier: 0.6,
      minWeightKg: 15
    },
    homeBodyweight: {
      name: "Push-up",
      isGiantSet: false
    }
  },

  inclineBench: {
    gym: {
      name: "Panca Inclinata",
      equipment: ['barbell', 'bench'],
      weightMultiplier: 0.6
    },
    homeWithEquipment: {
      name: "Panca Inclinata Manubri",
      equipment: ['dumbbell', 'bench'],
      weightMultiplier: 0.5,
      minWeightKg: 12
    },
    homeBodyweight: {
      name: "Pike Push-up",
      isGiantSet: false
    }
  },

  dips: {
    gym: {
      name: "Dips",
      equipment: ['none'],
      weightMultiplier: 0
    },
    homeWithEquipment: {
      name: "Dips (tra sedie)",
      equipment: ['none'],
      weightMultiplier: 0
    },
    homeBodyweight: {
      name: "Diamond Push-up",
      isGiantSet: false
    }
  },

  // DORSO - VERTICALE
  pullup: {
    gym: {
      name: "Trazioni",
      equipment: ['pullup_bar'],
      weightMultiplier: 0
    },
    homeWithEquipment: {
      name: "Trazioni",
      equipment: ['pullup_bar'],
      weightMultiplier: 0
    },
    homeBodyweight: {
      name: "GIANT_SET_PULLUP", // Speciale: floor slides
      isGiantSet: true
    }
  },

  chinup: {
    gym: {
      name: "Chin-up",
      equipment: ['pullup_bar'],
      weightMultiplier: 0
    },
    homeWithEquipment: {
      name: "Chin-up",
      equipment: ['pullup_bar'],
      weightMultiplier: 0
    },
    homeBodyweight: {
      name: "GIANT_SET_PULLUP",
      isGiantSet: true
    }
  },

  latPulldown: {
    gym: {
      name: "Lat Machine",
      equipment: ['barbell'], // macchina
      weightMultiplier: 0.7
    },
    homeWithEquipment: {
      name: "Band Pull-down",
      equipment: ['band'],
      weightMultiplier: 0
    },
    homeBodyweight: {
      name: "GIANT_SET_PULLUP",
      isGiantSet: true
    }
  },

  // DORSO - ORIZZONTALE
  barbellRow: {
    gym: {
      name: "Rematore Bilanciere",
      equipment: ['barbell'],
      weightMultiplier: 0.6
    },
    homeWithEquipment: {
      name: "Rematore Manubrio",
      equipment: ['dumbbell'],
      weightMultiplier: 0.5,
      minWeightKg: 12
    },
    homeBodyweight: {
      name: "Inverted Row",
      isGiantSet: false
    }
  },

  dumbbellRow: {
    gym: {
      name: "Rematore Manubrio",
      equipment: ['dumbbell'],
      weightMultiplier: 0.5
    },
    homeWithEquipment: {
      name: "Rematore Manubrio",
      equipment: ['dumbbell'],
      weightMultiplier: 0.5,
      minWeightKg: 10
    },
    homeBodyweight: {
      name: "Plank Row",
      isGiantSet: false
    }
  },

  // SPALLE
  militaryPress: {
    gym: {
      name: "Military Press Bilanciere",
      equipment: ['barbell'],
      weightMultiplier: 0.5
    },
    homeWithEquipment: {
      name: "Military Press Manubri",
      equipment: ['dumbbell'],
      weightMultiplier: 0.45,
      minWeightKg: 10
    },
    homeBodyweight: {
      name: "Pike Push-up",
      isGiantSet: false
    }
  },

  lateralRaise: {
    gym: {
      name: "Alzate Laterali",
      equipment: ['dumbbell'],
      weightMultiplier: 0.15
    },
    homeWithEquipment: {
      name: "Alzate Laterali Manubri",
      equipment: ['dumbbell'],
      weightMultiplier: 0.15,
      minWeightKg: 5
    },
    homeBodyweight: {
      name: "Band Lateral Raise",
      isGiantSet: false
    }
  },

  facePull: {
    gym: {
      name: "Face Pull",
      equipment: ['barbell'], // cavi
      weightMultiplier: 0.3
    },
    homeWithEquipment: {
      name: "Band Face Pull",
      equipment: ['band'],
      weightMultiplier: 0
    },
    homeBodyweight: {
      name: "Reverse Snow Angel",
      isGiantSet: false
    }
  },

  // BRACCIA
  barbellCurl: {
    gym: {
      name: "Curl Bilanciere",
      equipment: ['barbell'],
      weightMultiplier: 0.3
    },
    homeWithEquipment: {
      name: "Curl Manubri",
      equipment: ['dumbbell'],
      weightMultiplier: 0.25,
      minWeightKg: 8
    },
    homeBodyweight: {
      name: "Chin-up Hold",
      isGiantSet: false
    }
  },

  tricepPushdown: {
    gym: {
      name: "Pushdown Tricipiti",
      equipment: ['barbell'], // cavi
      weightMultiplier: 0.3
    },
    homeWithEquipment: {
      name: "Overhead Extension",
      equipment: ['dumbbell'],
      weightMultiplier: 0.25,
      minWeightKg: 8
    },
    homeBodyweight: {
      name: "Diamond Push-up",
      isGiantSet: false
    }
  }
};

// ===== GIANT SETS =====

export function createGiantSetDeadlift(goal: Goal, userWeight: number = 75): GiantSet {
  const configs: Record<Goal, {rounds: number, rest: number, reps: Record<string, string>}> = {
    strength: {
      rounds: 4,
      rest: 240,
      reps: { jump: "6-8", nordic: "4-6", gm: "8-10", hang: "30s" }
    },
    hypertrophy: {
      rounds: 4,
      rest: 150,
      reps: { jump: "10-12", nordic: "8-10", gm: "12-15", hang: "45s" }
    },
    weight_loss: {
      rounds: 5,
      rest: 90,
      reps: { jump: "15", nordic: "10", gm: "20", hang: "30s" }
    },
    performance: {
      rounds: 4,
      rest: 180,
      reps: { jump: "8-10", nordic: "6-8", gm: "10-12", hang: "40s" }
    },
    rehab: {
      rounds: 3,
      rest: 180,
      reps: { iso: "20-30s", bridge: "12-15", gm: "10-12", scap: "8-10" }
    }
  };

  const config = configs[goal];

  // Versione REHAB speciale (no balzi)
  if (goal === 'rehab') {
    return {
      id: 'giant_deadlift_rehab',
      name: 'Giant Set Catena Posteriore (Rehab)',
      category: 'giant_set',
      sets: 1, // non usato per giant set
      reps: `${config.rounds} giri`,
      rest: 0,
      rounds: config.rounds,
      restBetweenRounds: config.rest,
      exercises: [
        {
          name: "Squat Isometrico",
          reps: config.reps.iso,
          rest: 0,
          tempo: "Tenuta statica",
          notes: "Focus controllo e stabilit√†"
        },
        {
          name: "Ponte Glutei",
          reps: config.reps.bridge,
          rest: 0,
          tempo: "2s squeeze al top",
          notes: "No compensi lombari"
        },
        {
          name: "Good Morning Leggero",
          reps: config.reps.gm,
          rest: 0,
          notes: "ROM controllato, no carico"
        },
        {
          name: "Scapular Pull",
          reps: config.reps.scap,
          rest: 0,
          notes: "Attivazione scapolare, no trazione completa"
        }
      ],
      warningNote: "‚ö†Ô∏è Versione REHAB: movimenti controllati, ROM sicuro, no balzi o carichi pesanti.",
      notes: "Circuito per attivazione catena posteriore in sicurezza"
    };
  }

  // Versione standard per tutti gli altri obiettivi
  return {
    id: `giant_deadlift_${goal}`,
    name: `Giant Set Stacco - ${goal === 'strength' ? 'Forza' : goal === 'hypertrophy' ? 'Massa' : goal === 'performance' ? 'Performance' : 'Dimagrimento'}`,
    category: 'giant_set',
    sets: 1,
    reps: `${config.rounds} giri`,
    rest: 0,
    rounds: config.rounds,
    restBetweenRounds: config.rest,
    exercises: [
      {
        name: "Squat Jump",
        reps: config.reps.jump,
        rest: 0,
        tempo: "Esplosivo",
        notes: "Simula la fase di strappo dello stacco - quadricipiti e potenza"
      },
      {
        name: "Nordic Curl",
        reps: config.reps.nordic,
        rest: 0,
        tempo: "4-5s eccentrica",
        notes: "Femorali - eccentrico controllato, massima tensione"
      },
      {
        name: "Good Morning",
        reps: config.reps.gm,
        rest: 0,
        tempo: "Controllato",
        notes: "Erettori spinali + glutei - cerniera anca. Usa zaino carico se disponibile"
      },
      {
        name: "Dead Hang",
        reps: config.reps.hang,
        rest: 0,
        notes: "Grip e trapezi - presa massimale, scapole attive"
      }
    ],
    warningNote: `‚ö†Ô∏è LO STACCO CON BILANCIERE √à INSOSTITUIBILE. Questo giant set simula la fatica sistemica e l'effort tramite lavoro ad alta densit√† (ZERO pause tra esercizi), ma NON pu√≤ replicare la biomeccanica e il carico massimale dello stacco tradizionale. ${config.rounds} giri totali con ${config.rest}s di recupero TRA i giri.`,
    notes: `${config.rounds} giri - ZERO pause tra esercizi - ${config.rest}s recupero TRA giri`
  };
}

export function createGiantSetPullup(goal: Goal): GiantSet {
  const rounds = goal === 'weight_loss' ? 5 : goal === 'hypertrophy' ? 4 : 3;
  const rest = goal === 'weight_loss' ? 90 : goal === 'strength' ? 180 : 120;
  const repsMultiplier = goal === 'hypertrophy' ? 1.3 : goal === 'weight_loss' ? 1.5 : 1;

  return {
    id: 'giant_pullup_floor',
    name: 'Giant Set Dorsale (Floor Work)',
    category: 'giant_set',
    sets: 1,
    reps: `${rounds} giri`,
    rest: 0,
    rounds,
    restBetweenRounds: rest,
    exercises: [
      {
        name: "Floor Slide Rows",
        reps: `${Math.round(12 * repsMultiplier)}-${Math.round(15 * repsMultiplier)}`,
        rest: 0,
        tempo: "3s eccentrica",
        notes: "Sdraiato prono, mani avanti, 'scivola' indietro trascinandoti con dorsali (come passo giaguaro ma con DUE BRACCIA INSIEME)"
      },
      {
        name: "Scapular Push-up",
        reps: `${Math.round(15 * repsMultiplier)}`,
        rest: 0,
        tempo: "Controllato",
        notes: "In posizione plank, retrai/protrarre scapole - attivazione scapolare pura"
      },
      {
        name: "Superman Hold",
        reps: `${Math.round(30 * repsMultiplier)}s`,
        rest: 0,
        notes: "Isometrica: braccia estese avanti, tieni in alto - dorsali + erettori"
      },
      {
        name: "Hollow Body Hold",
        reps: "30s",
        rest: 0,
        notes: "Posizione antagonista - recupero attivo per core anteriore"
      }
    ],
    warningNote: `‚ö†Ô∏è LE TRAZIONI sono insostituibili per sviluppo dorsale width. Questo giant set allena attivazione scapolare, dorsali e core senza sbarra, ma non pu√≤ sostituire il pattern di trazione verticale con carico del corpo. Se possibile, installa una sbarra! ${rounds} giri con ${rest}s recupero.`,
    notes: `${rounds} giri - ZERO pause - ${rest}s recupero TRA giri`
  };
}

// ===== MOTORE SELEZIONE VARIANTE =====

export function selectExerciseVariant(
  exerciseKey: string,
  location: Location,
  equipment: UserEquipment,
  goal: Goal,
  assessmentWeight?: number
): Exercise | GiantSet {
  
  const variants = EXERCISE_DATABASE[exerciseKey];
  if (!variants) {
    throw new Error(`Exercise ${exerciseKey} not found in database`);
  }

  // CASO 1: PALESTRA
  if (location === 'gym') {
    const gymVariant = variants.gym;
    return {
      id: exerciseKey,
      name: gymVariant.name,
      sets: getDefaultSets(goal),
      reps: getDefaultReps(goal),
      rest: getDefaultRest(goal, 'compound'),
      weight: assessmentWeight ? assessmentWeight * gymVariant.weightMultiplier : undefined,
      category: 'compound',
      notes: 'Esercizio palestra standard'
    };
  }

  // CASO 2: CASA - controlla attrezzatura
  const homeWithEq = variants.homeWithEquipment;
  const homeBodyweight = variants.homeBodyweight;

  // Check se ha attrezzatura necessaria
  const hasRequiredEquipment = checkEquipment(homeWithEq.equipment, equipment);
  const hasMinWeight = equipment.dumbbellMaxKg >= (homeWithEq.minWeightKg || 0);

  // CASO 2A: Ha attrezzatura adeguata
  if (hasRequiredEquipment && hasMinWeight) {
    const availableWeight = Math.min(equipment.dumbbellMaxKg, assessmentWeight ? assessmentWeight * homeWithEq.weightMultiplier : equipment.dumbbellMaxKg);
    const plannedWeight = assessmentWeight ? assessmentWeight * homeWithEq.weightMultiplier : availableWeight;
    
    return {
      id: exerciseKey,
      name: homeWithEq.name,
      sets: getDefaultSets(goal),
      reps: getDefaultReps(goal),
      rest: getDefaultRest(goal, 'compound'),
      weight: availableWeight,
      category: 'compound',
      notes: availableWeight < plannedWeight ? 
        `‚ö†Ô∏è Peso disponibile ridotto: ${availableWeight}kg vs ${plannedWeight}kg pianificato` : 
        'Esercizio con attrezzatura casa'
    };
  }

  // CASO 2B: NO attrezzatura - bodyweight o giant set
  if (homeBodyweight.isGiantSet) {
    // Giant sets speciali
    if (homeBodyweight.name === 'GIANT_SET_DEADLIFT') {
      return createGiantSetDeadlift(goal, assessmentWeight);
    }
    if (homeBodyweight.name === 'GIANT_SET_PULLUP') {
      return createGiantSetPullup(goal);
    }
  }

  // Esercizio bodyweight normale
  return {
    id: exerciseKey,
    name: homeBodyweight.name,
    sets: getDefaultSets(goal, true), // bodyweight = pi√π sets
    reps: getDefaultReps(goal, true), // bodyweight = pi√π reps
    rest: getDefaultRest(goal, 'compound') - 20, // meno riposo
    category: 'compound',
    notes: 'Esercizio a corpo libero - compensato con volume aumentato'
  };
}

// ===== CALIBRAZIONE EFFORT =====

export interface EffortCalibration {
  setsMultiplier: number;
  repsMultiplier: number;
  restAdjustment: number; // +/- secondi
  tempo?: string;
  additionalExercise?: string;
  notes: string;
}

export function calibrateEffort(
  plannedWeight: number,
  availableWeight: number,
  goal: Goal,
  exerciseName: string
): EffortCalibration {
  
  const ratio = availableWeight / plannedWeight;

  // Peso OK (90%+)
  if (ratio >= 0.9) {
    return {
      setsMultiplier: 1,
      repsMultiplier: 1,
      restAdjustment: 0,
      notes: ''
    };
  }

  // Peso molto ridotto (<50%)
  if (ratio < 0.5) {
    return {
      setsMultiplier: 1,
      repsMultiplier: 1,
      restAdjustment: 0,
      notes: `‚ö†Ô∏è ATTENZIONE: Peso disponibile troppo basso (${availableWeight}kg vs ${plannedWeight}kg). Considera di cambiare esercizio o utilizzare tecniche avanzate (rest-pause, drop sets).`
    };
  }

  // Peso ridotto (50-90%) - calibrazione in base a obiettivo
  switch(goal) {
    case 'strength':
    case 'performance':
      return {
        setsMultiplier: 1.5,
        repsMultiplier: 1,
        restAdjustment: 30,
        tempo: "4-0-1-0",
        notes: `‚ö° Compensazione FORZA: +50% serie (${Math.round(1.5)} volte), tempo eccentrico lento (4s), recupero maggiore (+30s). Peso: ${availableWeight}kg disponibile vs ${plannedWeight}kg pianificato.`
      };

    case 'hypertrophy':
      return {
        setsMultiplier: 1,
        repsMultiplier: 1.5,
        restAdjustment: 0,
        tempo: "3-1-1-0",
        additionalExercise: `+ Aggiunto esercizio complementare per volume`,
        notes: `‚ö° Compensazione MASSA: +50% ripetizioni, TUT elevato (3s eccentrica, 1s pausa), stesso recupero. Peso: ${availableWeight}kg disponibile vs ${plannedWeight}kg pianificato.`
      };

    case 'weight_loss':
      return {
        setsMultiplier: 1.3,
        repsMultiplier: 1.2,
        restAdjustment: -20,
        tempo: "Esplosivo dove possibile",
        notes: `‚ö° Compensazione DIMAGRIMENTO: +30% serie, +20% reps, recupero ridotto (-20s) per aumentare densit√† metabolica. Peso: ${availableWeight}kg disponibile vs ${plannedWeight}kg pianificato.`
      };

    case 'rehab':
      return {
        setsMultiplier: 1,
        repsMultiplier: 1.2,
        restAdjustment: 0,
        tempo: "Molto controllato 2-0-2-0",
        notes: `Peso ridotto √® POSITIVO per rehab. Mantieni controllo e ROM completo. Peso: ${availableWeight}kg disponibile.`
      };

    default:
      return {
        setsMultiplier: 1.2,
        repsMultiplier: 1.2,
        restAdjustment: 0,
        notes: `‚ö° Peso ridotto: compensato con +20% volume. ${availableWeight}kg disponibile vs ${plannedWeight}kg pianificato.`
      };
  }
}

// ===== UTILITY FUNCTIONS =====

function checkEquipment(required: EquipmentType[], available: UserEquipment): boolean {
  for (const req of required) {
    switch(req) {
      case 'barbell':
        if (!available.barbell) return false;
        break;
      case 'dumbbell':
        if (available.dumbbellMaxKg === 0) return false;
        break;
      case 'kettlebell':
        if (available.kettlebellKg.length === 0) return false;
        break;
      case 'band':
        if (!available.bands) return false;
        break;
      case 'pullup_bar':
        if (!available.pullupBar) return false;
        break;
      case 'bench':
        if (!available.bench) return false;
        break;
      case 'none':
        return true;
    }
  }
  return true;
}

function getDefaultSets(goal: Goal, isBodyweight: boolean = false): number {
  const base = {
    strength: 5,
    hypertrophy: 4,
    weight_loss: 4,
    performance: 4,
    rehab: 3
  };
  
  return base[goal] + (isBodyweight ? 1 : 0);
}

function getDefaultReps(goal: Goal, isBodyweight: boolean = false): string {
  const base = {
    strength: isBodyweight ? "8-10" : "3-6",
    hypertrophy: isBodyweight ? "15-20" : "8-12",
    weight_loss: isBodyweight ? "20-25" : "12-15",
    performance: isBodyweight ? "10-15" : "6-10",
    rehab: isBodyweight ? "12-15" : "10-15"
  };
  
  return base[goal];
}

function getDefaultRest(goal: Goal, category: 'compound' | 'isolation'): number {
  const base = {
    strength: category === 'compound' ? 240 : 120,
    hypertrophy: category === 'compound' ? 120 : 60,
    weight_loss: category === 'compound' ? 90 : 45,
    performance: category === 'compound' ? 180 : 90,
    rehab: category === 'compound' ? 120 : 90
  };
  
  return base[goal];
}

// ===== GENERATORE PROGRAMMA COMPLETO =====

export interface WorkoutDay {
  day: number;
  name: string;
  focus: string;
  exercises: (Exercise | GiantSet)[];
}

export interface ProgramConfig {
  goal: Goal;
  location: Location;
  equipment: UserEquipment;
  frequency: number; // giorni/settimana
  assessments: Record<string, number>; // massimali test
}

export function generateAdaptiveProgram(config: ProgramConfig): WorkoutDay[] {
  const { goal, location, equipment, frequency, assessments } = config;
  
  // Determina split
  let split: 'fullbody' | 'upper_lower' | 'ppl';
  if (frequency <= 3) split = 'fullbody';
  else if (frequency === 4) split = 'upper_lower';
  else split = 'ppl';

  const days: WorkoutDay[] = [];

  // FULL BODY (2-3 giorni)
  if (split === 'fullbody') {
    for (let i = 0; i < frequency; i++) {
      const exercises: (Exercise | GiantSet)[] = [];
      
      // Squat
      exercises.push(
        selectExerciseVariant('squat', location, equipment, goal, assessments['squat'])
      );
      
      // Stacco (o giant set se casa bodyweight)
      exercises.push(
        selectExerciseVariant('deadlift', location, equipment, goal, assessments['deadlift'])
      );
      
      // Panca
      exercises.push(
        selectExerciseVariant('benchPress', location, equipment, goal, assessments['benchPress'])
      );
      
      // Trazioni (o giant set se casa senza sbarra)
      exercises.push(
        selectExerciseVariant('pullup', location, equipment, goal, assessments['pullup'])
      );
      
      // Spalle
      exercises.push(
        selectExerciseVariant('militaryPress', location, equipment, goal, assessments['militaryPress'])
      );

      days.push({
        day: i + 1,
        name: `Full Body ${String.fromCharCode(65 + i)}`, // A, B, C
        focus: 'Tutto il corpo',
        exercises
      });
    }
  }

  // UPPER/LOWER (4 giorni)
  if (split === 'upper_lower') {
    // Upper 1
    const upper1: (Exercise | GiantSet)[] = [
      selectExerciseVariant('benchPress', location, equipment, goal, assessments['benchPress']),
      selectExerciseVariant('barbellRow', location, equipment, goal, assessments['barbellRow']),
      selectExerciseVariant('militaryPress', location, equipment, goal, assessments['militaryPress']),
      selectExerciseVariant('pullup', location, equipment, goal, assessments['pullup']),
      selectExerciseVariant('lateralRaise', location, equipment, goal, assessments['lateralRaise'])
    ];

    // Lower 1
    const lower1: (Exercise | GiantSet)[] = [
      selectExerciseVariant('squat', location, equipment, goal, assessments['squat']),
      selectExerciseVariant('romanianDeadlift', location, equipment, goal, assessments['romanianDeadlift']),
      selectExerciseVariant('legPress', location, equipment, goal, assessments['legPress']),
      selectExerciseVariant('legCurl', location, equipment, goal, assessments['legCurl'])
    ];

    // Upper 2 (variazioni)
    const upper2: (Exercise | GiantSet)[] = [
      selectExerciseVariant('inclineBench', location, equipment, goal, assessments['inclineBench']),
      selectExerciseVariant('chinup', location, equipment, goal, assessments['chinup']),
      selectExerciseVariant('dumbbellRow', location, equipment, goal, assessments['dumbbellRow']),
      selectExerciseVariant('dips', location, equipment, goal, assessments['dips']),
      selectExerciseVariant('facePull', location, equipment, goal, assessments['facePull'])
    ];

    // Lower 2
    const lower2: (Exercise | GiantSet)[] = [
      selectExerciseVariant('frontSquat', location, equipment, goal, assessments['frontSquat']),
      selectExerciseVariant('deadlift', location, equipment, goal, assessments['deadlift']),
      selectExerciseVariant('legCurl', location, equipment, goal, assessments['legCurl'])
    ];

    days.push(
      { day: 1, name: 'Upper A', focus: 'Parte superiore - Forza', exercises: upper1 },
      { day: 2, name: 'Lower A', focus: 'Parte inferiore - Forza', exercises: lower1 },
      { day: 3, name: 'Upper B', focus: 'Parte superiore - Volume', exercises: upper2 },
      { day: 4, name: 'Lower B', focus: 'Parte inferiore - Volume', exercises: lower2 }
    );
  }

  // PUSH/PULL/LEGS (5-6 giorni)
  if (split === 'ppl') {
    // Push
    const push: (Exercise | GiantSet)[] = [
      selectExerciseVariant('benchPress', location, equipment, goal, assessments['benchPress']),
      selectExerciseVariant('inclineBench', location, equipment, goal, assessments['inclineBench']),
      selectExerciseVariant('militaryPress', location, equipment, goal, assessments['militaryPress']),
      selectExerciseVariant('lateralRaise', location, equipment, goal, assessments['lateralRaise']),
      selectExerciseVariant('dips', location, equipment, goal, assessments['dips']),
      selectExerciseVariant('tricepPushdown', location, equipment, goal, assessments['tricepPushdown'])
    ];

    // Pull
    const pull: (Exercise | GiantSet)[] = [
      selectExerciseVariant('deadlift', location, equipment, goal, assessments['deadlift']),
      selectExerciseVariant('pullup', location, equipment, goal, assessments['pullup']),
      selectExerciseVariant('barbellRow', location, equipment, goal, assessments['barbellRow']),
      selectExerciseVariant('dumbbellRow', location, equipment, goal, assessments['dumbbellRow']),
      selectExerciseVariant('facePull', location, equipment, goal, assessments['facePull']),
      selectExerciseVariant('barbellCurl', location, equipment, goal, assessments['barbellCurl'])
    ];

    // Legs
    const legs: (Exercise | GiantSet)[] = [
      selectExerciseVariant('squat', location, equipment, goal, assessments['squat']),
      selectExerciseVariant('romanianDeadlift', location, equipment, goal, assessments['romanianDeadlift']),
      selectExerciseVariant('legPress', location, equipment, goal, assessments['legPress']),
      selectExerciseVariant('legCurl', location, equipment, goal, assessments['legCurl'])
    ];

    days.push(
      { day: 1, name: 'Push A', focus: 'Spinta (Petto/Spalle/Tricipiti)', exercises: push },
      { day: 2, name: 'Pull A', focus: 'Trazione (Dorso/Bicipiti)', exercises: pull },
      { day: 3, name: 'Legs A', focus: 'Gambe', exercises: legs }
    );

    if (frequency >= 6) {
      days.push(
        { day: 4, name: 'Push B', focus: 'Spinta (Volume)', exercises: push },
        { day: 5, name: 'Pull B', focus: 'Trazione (Volume)', exercises: pull },
        { day: 6, name: 'Legs B', focus: 'Gambe (Volume)', exercises: legs }
      );
    }
  }

  return days;
}

// ===== ESEMPIO USO =====

export function exampleUsage() {
  const config: ProgramConfig = {
    goal: 'hypertrophy',
    location: 'home',
    equipment: {
      barbell: false,
      dumbbellMaxKg: 15,
      kettlebellKg: [12, 16],
      bands: true,
      pullupBar: false,
      bench: false
    },
    frequency: 3,
    assessments: {
      squat: 100,
      deadlift: 120,
      benchPress: 80,
      pullup: 0, // bodyweight
      militaryPress: 50
    }
  };

  const program = generateAdaptiveProgram(config);
  
  console.log("=== PROGRAMMA GENERATO ===\n");
  
  program.forEach(day => {
    console.log(`\n${day.name} - ${day.focus}`);
    console.log("‚îÄ".repeat(50));
    
    day.exercises.forEach((ex, idx) => {
      if ('rounds' in ex) {
        // Giant Set
        const gs = ex as GiantSet;
        console.log(`\n${idx + 1}. üî• ${gs.name}`);
        console.log(`   ${gs.rounds} giri - ${gs.restBetweenRounds}s recupero TRA giri`);
        gs.exercises.forEach((subEx, subIdx) => {
          console.log(`   ${subIdx + 1}) ${subEx.name} - ${subEx.reps}`);
          console.log(`      ${subEx.notes}`);
        });
        console.log(`   ‚ö†Ô∏è ${gs.warningNote}`);
      } else {
        // Esercizio normale
        const e = ex as Exercise;
        console.log(`\n${idx + 1}. ${e.name}`);
        console.log(`   ${e.sets} serie x ${e.reps} reps - ${e.rest}s recupero`);
        if (e.weight) console.log(`   Peso: ${e.weight}kg`);
        if (e.tempo) console.log(`   Tempo: ${e.tempo}`);
        if (e.notes) console.log(`   üìù ${e.notes}`);
      }
    });
  });

  // Test calibrazione
  console.log("\n\n=== TEST CALIBRAZIONE EFFORT ===\n");
  const calibration = calibrateEffort(100, 60, 'hypertrophy', 'Squat');
  console.log(`Pianificato: 100kg | Disponibile: 60kg`);
  console.log(`Sets multiplier: ${calibration.setsMultiplier}x`);
  console.log(`Reps multiplier: ${calibration.repsMultiplier}x`);
  console.log(`Tempo: ${calibration.tempo}`);
  console.log(`Note: ${calibration.notes}`);
}

// Run example
// exampleUsage();