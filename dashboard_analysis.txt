        const screeningData = JSON.parse(screeningDataRaw);
        
        programInput = {
          userId,
          assessmentId: screeningId,
          location: onboardingData.trainingLocation,
          hasGym: onboardingData.trainingLocation === 'gym',
          equipment: onboardingData.equipment || {},
          goal: mapGoal(onboardingData.goal || 'muscle_gain'),
          level: quizData.level || screeningData.level || 'intermediate',
          frequency: onboardingData.activityLevel?.weeklyFrequency || 3,
          painAreas: onboardingData.painAreas || screeningData.painAreas || [],
          disabilityType: onboardingData.disabilityType || null,
          sportRole: mapSportRole(onboardingData.sport, onboardingData.sportRole),
          specificBodyParts: onboardingData.specificBodyParts || []
        };
      }

      console.log('ðŸ“¤ Sending program input:', programInput);

      const response = await fetch('/api/program-generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(programInput),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to generate program');
      }

      const data = await response.json();
      console.log('âœ… Program generated:', data);

      window.location.reload();

    } catch (error) {
      console.error('Error generating program:', error);
      alert('Errore nella generazione del programma. Riprova.');
