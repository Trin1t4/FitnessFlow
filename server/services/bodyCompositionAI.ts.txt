import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);

interface BodyCompositionParams {
  photos: {
    front?: Buffer;
    back?: Buffer;
    side?: Buffer;
  };
  weight: number;
  height: number; // in cm
}

interface BodyCompositionResult {
  bodyFatPercentage: number;
  muscleMass: "low" | "medium" | "high";
  posture: {
    shoulderAlignment: string;
    spineAlignment: string;
    notes: string;
  };
  recommendations: string[];
  confidence: number;
}

export async function analyzeBodyComposition(
  params: BodyCompositionParams
): Promise<BodyCompositionResult> {
  try {
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro" });

    const bmi = params.weight / Math.pow(params.height / 100, 2);

    const prompt = `
Sei un esperto di analisi della composizione corporea e valutazione posturale.

DATI ANTROPOMETRICI:
- Peso: ${params.weight} kg
- Altezza: ${params.height} cm
- BMI calcolato: ${bmi.toFixed(1)}

COMPITO:
Analizza le foto fornite (fronte, retro, fianco) e fornisci una valutazione dettagliata della composizione corporea e della postura.

RISPONDI IN FORMATO JSON (solo JSON valido, niente altro testo):
{
  "bodyFatPercentage": <numero tra 8 e 45>,
  "muscleMass": "<low/medium/high>",
  "posture": {
    "shoulderAlignment": "<neutro/anteriore/posteriore>",
    "spineAlignment": "<neutro/cifosi/lordosi>",
    "notes": "<max 100 caratteri di note posturali>"
  },
  "recommendations": [
    "<raccomandazione specifica 1>",
    "<raccomandazione specifica 2>",
    "<raccomandazione specifica 3>"
  ],
  "confidence": <numero tra 0.6 e 0.95>
}

LINEE GUIDA:
- Stima la percentuale di grasso corporeo basandoti su definizione muscolare, curve corporee e distribuzione del grasso
- Valuta la massa muscolare comparando con standard per sesso/età
- Analizza attentamente la postura: spalle, colonna vertebrale, bacino
- Fornisci raccomandazioni PRATICHE per l'allenamento (non mediche)
- Sii preciso ma non diagnostico
- Il confidence deve riflettere la qualità delle foto (0.8-0.9 se buone, 0.6-0.7 se mediocri)

ESEMPI DI RACCOMANDAZIONI:
- "Focus su esercizi di rinforzo core per migliorare postura"
- "Includere stretching spalle per correggere rotazione anteriore"
- "Prioritizzare allenamento forza per aumentare massa muscolare"
- "Aggiungere cardio moderato per riduzione grasso corporeo"
`;

    const imageParts = [];

    // Convert buffers to base64 and add to prompt
    for (const [position, buffer] of Object.entries(params.photos)) {
      if (buffer) {
        const base64 = buffer.toString("base64");
        imageParts.push({
          inlineData: {
            data: base64,
            mimeType: "image/jpeg",
          },
        });
      }
    }

    if (imageParts.length === 0) {
      // Fallback: analysis based only on BMI
      return fallbackBMIAnalysis(bmi);
    }

    const result = await model.generateContent([prompt, ...imageParts]);
    const response = await result.response.text();

    // Extract JSON from response
    const jsonMatch = response.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error("Invalid JSON in AI response");
    }

    const analysis: BodyCompositionResult = JSON.parse(jsonMatch[0]);

    // Validate response
    if (
      !analysis.bodyFatPercentage ||
      !analysis.muscleMass ||
      !analysis.recommendations
    ) {
      throw new Error("Incomplete AI response");
    }

    return analysis;
  } catch (error) {
    console.error("Body composition AI error:", error);
    
    // Fallback to BMI-based estimation
    const bmi = params.weight / Math.pow(params.height / 100, 2);
    return fallbackBMIAnalysis(bmi);
  }
}

function fallbackBMIAnalysis(bmi: number): BodyCompositionResult {
  let bodyFat = 20;
  let muscleMass: "low" | "medium" | "high" = "medium";
  const recommendations: string[] = [];

  if (bmi < 18.5) {
    bodyFat = 12;
    muscleMass = "low";
    recommendations.push("Aumentare apporto calorico per guadagno massa");
    recommendations.push("Focus su esercizi compound con progressione carico");
    recommendations.push("Ridurre cardio eccessivo");
  } else if (bmi >= 18.5 && bmi < 25) {
    bodyFat = 18;
    muscleMass = "medium";
    recommendations.push("Mantenere allenamento bilanciato forza/cardio");
    recommendations.push("Ottimizzare apporto proteico per composizione corporea");
    recommendations.push("Considerare periodizzazione per miglioramenti");
  } else if (bmi >= 25 && bmi < 30) {
    bodyFat = 28;
    muscleMass = "medium";
    recommendations.push("Includere cardio HIIT 2-3x/settimana");
    recommendations.push("Mantenere allenamento forza per preservare massa");
    recommendations.push("Deficit calorico moderato con alto apporto proteico");
  } else {
    bodyFat = 35;
    muscleMass = "low";
    recommendations.push("Iniziare con cardio a bassa intensità e allenamento funzionale");
    recommendations.push("Progressione graduale con focus su mobilità");
    recommendations.push("Considerare supporto nutrizionale professionale");
  }

  return {
    bodyFatPercentage: bodyFat,
    muscleMass,
    posture: {
      shoulderAlignment: "Non valutabile senza foto",
      spineAlignment: "Non valutabile senza foto",
      notes: "Carica foto per analisi posturale dettagliata",
    },
    recommendations,
    confidence: 0.6, // Lower confidence without photos
  };
}

export async function calculateBMI(weight: number, height: number): Promise<number> {
  // height in cm
  return weight / Math.pow(height / 100, 2);
}

export function getBMICategory(bmi: number): {
  category: string;
  color: string;
  description: string;
} {
  if (bmi < 18.5) {
    return {
      category: "Sottopeso",
      color: "amber",
      description: "Potrebbe essere benefico aumentare la massa corporea",
    };
  } else if (bmi < 25) {
    return {
      category: "Normopeso",
      color: "green",
      description: "Peso ideale per la salute generale",
    };
  } else if (bmi < 30) {
    return {
      category: "Sovrappeso",
      color: "orange",
      description: "Considerare riduzione del peso corporeo",
    };
  } else {
    return {
      category: "Obesità",
      color: "red",
      description: "Consigliato supporto professionale per gestione peso",
    };
  }
}